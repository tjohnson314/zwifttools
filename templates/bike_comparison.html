<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Comparison - Zwift Activity Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/static/css/bike_comparison.css">
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <div>
                <a href="/" class="back-link">‚Üê Back to Tools</a>
                <h1>üö¥ Bike Comparison</h1>
                <p class="subtitle">Compare your race performance with different bike setups</p>
            </div>
            <div class="auth-section">
                <span id="authStatus" class="auth-status">Checking...</span>
                <button id="authBtn" class="btn-auth" onclick="handleAuth()" style="display: none;">Login with Zwift</button>
            </div>
        </div>
        
        <!-- Data Source Section -->
        <div class="activity-section">
            <div style="display: flex; gap: 30px; flex-wrap: wrap; width: 100%;">
                <!-- Fetch by Activity ID -->
                <div style="flex: 1; min-width: 300px;">
                    <label for="activityId">Fetch by Activity ID: <span style="color: #888; font-weight: normal;">(requires login)</span></label>
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <input type="text" id="activityId" placeholder="e.g., 2061903945080504368" style="flex: 1;">
                        <button class="btn btn-primary" id="fetchBtn" onclick="fetchActivity()">
                            Fetch
                        </button>
                    </div>
                    <a id="activityLink" href="#" target="_blank" style="display: none; margin-top: 6px; font-size: 0.85rem; color: #4fc3f7;">View on Zwift ‚Üó</a>
                </div>
                <!-- OR divider -->
                <div style="display: flex; align-items: center; padding-top: 18px; color: #888; font-weight: 600;">OR</div>
                <!-- Upload .fit file -->
                <div style="flex: 1; min-width: 300px;">
                    <label>Upload .fit file:</label>
                    <div style="display: flex; gap: 10px; margin-top: 8px; align-items: center;">
                        <label class="fit-upload-label" id="fitUploadLabel" for="fitFileInput">
                            Choose .fit file
                        </label>
                        <input type="file" id="fitFileInput" accept=".fit" style="display: none;" onchange="handleFitSelect(this)">
                        <span id="fitFileName" style="color: #aaa; font-size: 0.9rem; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">No file selected</span>
                        <button class="btn btn-primary" id="fitUploadBtn" onclick="uploadFitFile()" disabled>
                            Upload
                        </button>
                    </div>
                    <div style="margin-top: 6px; font-size: 0.8rem; color: #888;">
                        Supports Garmin, Wahoo, Zwift .fit exports
                    </div>
                </div>
            </div>
            <span class="activity-info" id="activityInfo" style="margin-top: 10px; display: block;"></span>
        </div>
        
        <!-- Time Range Slider -->
        <div class="time-range-container" id="timeRangeContainer">
            <div class="time-range-header">
                <label>‚è± Analysis Time Range</label>
                <div class="time-range-values">
                    <span id="rangeStartLabel">0:00</span> ‚Äî <span id="rangeEndLabel">0:00</span>
                    <span id="rangeDuration" style="color: #888; margin-left: 8px;"></span>
                </div>
            </div>
            <div class="dual-range">
                <div class="range-track"></div>
                <div class="range-track-fill" id="rangeTrackFill"></div>
                <input type="range" id="rangeStart" min="0" max="100" value="0" step="1">
                <input type="range" id="rangeEnd" min="0" max="100" value="100" step="1">
            </div>
            <div class="time-range-points" id="rangePointsInfo"></div>
        </div>
        
        <!-- Bike Panels -->
        <div class="bike-panels">
            <!-- Actual Bike -->
            <div class="bike-panel actual">
                <h2><span class="bike-icon">üö≤</span> Your Actual Bike</h2>
                
                <div class="form-group">
                    <label>Frame</label>
                    <select id="actualFrame" onchange="updateBikeStats('actual')">
                        <option value="">Loading frames...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Wheels</label>
                    <select id="actualWheels" onchange="updateBikeStats('actual')">
                        <option value="">Loading wheels...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Upgrade Level</label>
                    <select id="actualLevel" onchange="updateBikeStats('actual')">
                        <option value="0">Level 0 (Stock)</option>
                        <option value="1">Level 1</option>
                        <option value="2">Level 2</option>
                        <option value="3">Level 3</option>
                        <option value="4">Level 4</option>
                        <option value="5">Level 5 (Max)</option>
                    </select>
                </div>
                
                <div class="stats-box" id="actualStats">
                    <div class="stats-row">
                        <span class="stats-label">Air Resistance (Cd)</span>
                        <span class="stats-value cd" id="actualCd">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">Bike Weight</span>
                        <span class="stats-value weight" id="actualWeight">-</span>
                    </div>
                </div>
            </div>
            
            <!-- Comparison Arrows -->
            <div class="comparison-arrows">
                <button class="btn-copy" onclick="copyBike('actual','alt')" title="Copy actual bike to alternative">‚Üí</button>
                <button class="btn-copy" onclick="copyBike('alt','actual')" title="Copy alternative bike to actual">‚Üê</button>
            </div>
            
            <!-- Alternative Bike -->
            <div class="bike-panel alternative">
                <h2><span class="bike-icon">üö¥</span> Alternative Bike</h2>
                
                <div class="form-group">
                    <label>Frame</label>
                    <select id="altFrame" onchange="updateBikeStats('alt')">
                        <option value="">Loading frames...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Wheels</label>
                    <select id="altWheels" onchange="updateBikeStats('alt')">
                        <option value="">Loading wheels...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Upgrade Level</label>
                    <select id="altLevel" onchange="updateBikeStats('alt')">
                        <option value="0">Level 0 (Stock)</option>
                        <option value="1">Level 1</option>
                        <option value="2">Level 2</option>
                        <option value="3">Level 3</option>
                        <option value="4">Level 4</option>
                        <option value="5">Level 5 (Max)</option>
                    </select>
                </div>
                
                <div class="stats-box" id="altStats">
                    <div class="stats-row">
                        <span class="stats-label">Air Resistance (Cd)</span>
                        <span class="stats-value cd" id="altCd">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">Bike Weight</span>
                        <span class="stats-value weight" id="altWeight">-</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Rider Settings -->
        <div class="rider-section">
            <h3>‚öôÔ∏è Rider Settings</h3>
            <div class="rider-panels">
                <div class="rider-panel actual">
                    <h4>üö≤ Actual Rider</h4>
                    <div class="rider-input">
                        <label>Height:</label>
                        <input type="number" id="actualRiderHeight" value="175" min="140" max="210">
                        <span>cm</span>
                    </div>
                    <div class="rider-input">
                        <label>Weight:</label>
                        <input type="number" id="actualRiderWeight" value="75" min="40" max="150">
                        <span>kg</span>
                    </div>
                    <div class="rider-input">
                        <label>Frontal Area:</label>
                        <span class="frontal-area-value" id="actualFrontalAreaValue">0.360</span>
                        <span>m¬≤</span>
                    </div>
                </div>
                <div class="rider-copy-arrows">
                    <button class="btn-copy" onclick="copyRider('actual','alt')" title="Copy actual rider to alternative">‚Üí</button>
                    <button class="btn-copy" onclick="copyRider('alt','actual')" title="Copy alternative rider to actual">‚Üê</button>
                </div>
                <div class="rider-panel alternative">
                    <h4>üö¥ Alternative Rider <button class="btn-use-my-stats" onclick="applyMyStats('alt')" title="Uses your current in-game height &amp; weight from your Zwift profile">Use My Stats</button></h4>
                    <div class="rider-input">
                        <label>Height:</label>
                        <input type="number" id="altRiderHeight" value="175" min="140" max="210">
                        <span>cm</span>
                    </div>
                    <div class="rider-input">
                        <label>Weight:</label>
                        <input type="number" id="altRiderWeight" value="75" min="40" max="150">
                        <span>kg</span>
                    </div>
                    <div class="rider-input">
                        <label>Frontal Area:</label>
                        <span class="frontal-area-value" id="altFrontalAreaValue">0.360</span>
                        <span>m¬≤</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Section (hidden until comparison runs) -->
        <div class="results-section hidden" id="resultsSection">
            <h2>üìä Race Comparison Results</h2>
            
            <div class="summary-cards">
                <div class="summary-card neutral">
                    <div class="value" id="actualNp">-</div>
                    <div class="label">Actual NP (W)</div>
                </div>
                <div class="summary-card neutral">
                    <div class="value" id="altNp">-</div>
                    <div class="label">Alternative NP (W)</div>
                </div>
                <div class="summary-card" id="diffCard">
                    <div class="value" id="npDiff">-</div>
                    <div class="label">NP Difference</div>
                </div>
                <div class="summary-card" id="avgDiffCard">
                    <div class="value" id="avgWattsDiff">-</div>
                    <div class="label">Avg Watts Difference</div>
                </div>
            </div>
            
            <!-- Power Chart -->
            <div class="chart-container">
                <h3>Power Required Over Time</h3>
                <div class="chart-wrapper">
                    <canvas id="powerChart"></canvas>
                </div>
            </div>
            
            <!-- Difference Chart -->
            <div class="chart-container">
                <h3>Watts Difference (Alternative - Actual)</h3>
                <div class="chart-wrapper">
                    <canvas id="diffChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Top 10 Best Bikes Section -->
        <div class="speed-table-section" style="background: linear-gradient(135deg, #1e3c2e 0%, #1a1a2e 100%); border: 1px solid #2d5a3f;">
            <h2>üèÜ Find Best Bike Setups</h2>
            <p>Search bike combinations to find the ones that minimize your Normalized Power for this route</p>
            
            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                <div>
                    <label>Upgrade Level:</label>
                    <select id="bestBikesLevel" style="width: 120px; padding: 8px; border-radius: 6px; background: #1a1a2e; color: #fff; border: 2px solid #333;">
                        <option value="0">Level 0</option>
                        <option value="1">Level 1</option>
                        <option value="2">Level 2</option>
                        <option value="3">Level 3</option>
                        <option value="4">Level 4</option>
                        <option value="5" selected>Level 5 (Max)</option>
                    </select>
                </div>
                <div>
                    <label title="Only show bikes unlocked at or below this rider level">Max Rider Level:</label>
                    <select id="maxRiderLevel" style="width: 120px; padding: 8px; border-radius: 6px; background: #1a1a2e; color: #fff; border: 2px solid #333;">
                        <option value="" selected>Any</option>
                    </select>
                </div>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="excludeTT" checked style="width: 18px; height: 18px;">
                    <span>Exclude TT bikes</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="excludeSpecial" checked style="width: 18px; height: 18px;">
                    <span title="Exclude bikes with special unlock requirements (e.g. challenge rewards, event prizes, Halo bikes)">Exclude special unlocks</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="usePareto" checked style="width: 18px; height: 18px;">
                    <span title="Only tests bikes that aren't beaten in BOTH aero and weight by another bike. Dramatically reduces combinations without missing potential winners.">Use Pareto frontier (faster)</span>
                </label>
                <button class="btn btn-primary" id="findBestBtn" onclick="findBestBikes()" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);" disabled>
                    üîç Find Top 10 Best Bikes
                </button>
                <span id="bestBikesStatus" style="color: #888;"></span>
            </div>
            
            <div id="bestBikesContainer" class="hidden">
                <div style="margin-bottom: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                    <span style="color: #888;">Your Actual NP:</span>
                    <span id="actualNpValue" style="font-size: 1.5rem; font-weight: bold; color: #f7931e; margin-left: 10px;">-</span>
                </div>
                
                <div id="excludedFramesBar" style="display: none; margin-bottom: 12px; padding: 10px 14px; background: rgba(244,67,54,0.1); border: 1px solid rgba(244,67,54,0.3); border-radius: 8px;">
                    <span style="color: #f44336; font-size: 0.85rem; font-weight: 600;">Excluded:</span>
                    <span id="excludedFramesList" style="margin-left: 8px;"></span>
                    <button onclick="clearExcludedFrames()" style="margin-left: 12px; padding: 2px 10px; font-size: 0.8rem; border-radius: 4px; border: 1px solid #f44336; background: transparent; color: #f44336; cursor: pointer;">Clear all</button>
                </div>
                
                <h3 style="color: #4caf50; margin-bottom: 15px;">‚úì Top 10 Best Bikes (Lowest NP)</h3>
                <table class="speed-table" id="bestBikesTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Bike Setup</th>
                            <th>Cd</th>
                            <th>Weight</th>
                            <th title="Total Drops cost: frame + wheels + upgrades">Total Drops</th>
                            <th>NP</th>
                            <th>vs Actual</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="bestBikesBody">
                    </tbody>
                </table>
                <div id="bestBikesFootnote" style="display: none; margin-top: 6px; font-size: 0.8rem; color: #888;">
                    * Has special unlock requirements (e.g. challenge completion, event reward, or upgrading other bikes)
                </div>
            </div>
        </div>
    </div>

    {% include 'bike_comparison_faq.html' %}
    
    <script>
        // Global state
        let frames = [];
        let wheels = [];
        let telemetryData = null;
        let fullTelemetryData = null;  // Unfiltered copy for range slider
        let powerChart = null;
        let diffChart = null;
        let isAuthenticated = false;
        let myProfile = null;  // {height_cm, weight_kg, name}
        let excludedFrames = new Set();  // Frame IDs excluded from best bikes search
        
        // Authentication functions
        async function checkAuthStatus() {
            try {
                const resp = await fetch('/auth/status');
                const data = await resp.json();
                
                const statusEl = document.getElementById('authStatus');
                const btnEl = document.getElementById('authBtn');
                
                isAuthenticated = data.authenticated;
                
                if (data.authenticated && data.method === 'oauth') {
                    // Logged in via OAuth - show logout
                    statusEl.textContent = '‚úì Logged in via Zwift';
                    statusEl.className = 'auth-status logged-in';
                    btnEl.textContent = 'Logout';
                    btnEl.className = 'btn-auth logout';
                } else if (data.authenticated && data.method === 'config') {
                    // Using config token - offer OAuth login for fresh token
                    statusEl.textContent = 'Using config token (may be stale)';
                    statusEl.className = 'auth-status';
                    btnEl.textContent = 'Login with Zwift';
                    btnEl.className = 'btn-auth';
                    isAuthenticated = false;  // Allow login button to work
                } else {
                    statusEl.textContent = 'Not logged in';
                    statusEl.className = 'auth-status';
                    btnEl.textContent = 'Login with Zwift';
                    btnEl.className = 'btn-auth';
                }
                btnEl.style.display = 'inline-block';
            } catch (e) {
                console.error('Failed to check auth status:', e);
            }
        }
        
        function handleAuth() {
            if (isAuthenticated) {
                window.location.href = '/auth/logout';
            } else {
                window.location.href = '/auth/login?next=/bike-comparison';
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Restore cached activity ID
            // Check URL parameter first, then localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const urlActivityId = urlParams.get('activity') || urlParams.get('activity_id');
            const savedActivityId = localStorage.getItem('zwift_activityId');
            const activityId = urlActivityId || savedActivityId;
            if (activityId) {
                document.getElementById('activityId').value = activityId;
            }
            updateActivityLink();
            
            await checkAuthStatus();
            await loadMyProfile();
            await loadFrames();
            await loadWheels();
            
            // Populate max rider level dropdown from frame and wheel unlock levels
            const levelSet = new Set([
                ...frames.map(f => f.level),
                ...wheels.map(w => w.level)
            ].filter(l => l > 0));
            const levels = [...levelSet].sort((a, b) => a - b);
            const riderLevelSelect = document.getElementById('maxRiderLevel');
            levels.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l;
                opt.textContent = `Level ${l}`;
                riderLevelSelect.appendChild(opt);
            });
            
            // Auto-fetch if activity ID came from URL parameter
            if (urlActivityId) {
                fetchActivity();
            }
        });
        
        function frameHasBuiltInWheels(frameId) {
            const frame = frames.find(f => f.id === frameId);
            return frame ? frame.hasBuiltInWheels : false;
        }
        
        function getFrameType(frameId) {
            const frame = frames.find(f => f.id === frameId);
            return frame ? (frame.frameType || 'Standard') : 'Standard';
        }
        
        function getCompatibleWheels(frameType) {
            // Filter wheels to only those compatible with the selected frame type
            return wheels.filter(w => {
                if (w.id === '') return false;  // Skip built-in placeholder
                const fits = (w.fitsFrame || 'Standard,TT').split(',').map(s => s.trim());
                return fits.includes(frameType);
            });
        }
        
        function syncWheelDropdownState(prefix) {
            const frameId = document.getElementById(prefix + 'Frame').value;
            const wheelSelect = document.getElementById(prefix + 'Wheels');
            const previousValue = wheelSelect.value;
            
            if (frameHasBuiltInWheels(frameId)) {
                wheelSelect.innerHTML = '<option value="">(Built-in wheels)</option>';
                wheelSelect.value = '';
                wheelSelect.disabled = true;
            } else {
                // Filter wheels by frame type compatibility
                const frameType = getFrameType(frameId);
                const compatible = getCompatibleWheels(frameType);
                
                wheelSelect.innerHTML = compatible
                    .map(w => `<option value="${w.id}">${w.name} (A:${w.aero} W:${w.weight})</option>`)
                    .join('');
                wheelSelect.disabled = false;
                
                // Try to restore previous selection if still compatible
                if (compatible.some(w => w.id === previousValue)) {
                    wheelSelect.value = previousValue;
                }
            }
        }
        
        async function loadFrames() {
            try {
                const resp = await fetch('/api/frames');
                frames = await resp.json();
                
                const html = frames.map(f => 
                    `<option value="${f.id}">${f.name} (A:${f.aero} W:${f.weight})</option>`
                ).join('');
                
                document.getElementById('actualFrame').innerHTML = html;
                document.getElementById('altFrame').innerHTML = html;
                
                // Restore from cache or use defaults
                const savedActualFrame = localStorage.getItem('zwift_actualFrame');
                const savedAltFrame = localStorage.getItem('zwift_altFrame');
                
                if (savedActualFrame && frames.some(f => f.id === savedActualFrame)) {
                    document.getElementById('actualFrame').value = savedActualFrame;
                } else {
                    const tronIdx = frames.findIndex(f => f.id === 'F089');
                    if (tronIdx >= 0) document.getElementById('actualFrame').selectedIndex = tronIdx;
                }
                
                if (savedAltFrame && frames.some(f => f.id === savedAltFrame)) {
                    document.getElementById('altFrame').value = savedAltFrame;
                } else {
                    const tarmacIdx = frames.findIndex(f => f.id === 'F122');
                    if (tarmacIdx >= 0) document.getElementById('altFrame').selectedIndex = tarmacIdx;
                }
            } catch (e) {
                console.error('Failed to load frames:', e);
            }
        }
        
        async function loadWheels() {
            try {
                const resp = await fetch('/api/wheels');
                wheels = await resp.json();
                
                // Sync wheel dropdowns ‚Äî filters by frame type compatibility
                syncWheelDropdownState('actual');
                syncWheelDropdownState('alt');
                
                // Restore from cache or use defaults (skip for built-in wheel frames)
                const savedActualWheels = localStorage.getItem('zwift_actualWheels');
                const savedAltWheels = localStorage.getItem('zwift_altWheels');
                
                if (!frameHasBuiltInWheels(document.getElementById('actualFrame').value)) {
                    if (savedActualWheels && document.getElementById('actualWheels').querySelector(`option[value="${savedActualWheels}"]`)) {
                        document.getElementById('actualWheels').value = savedActualWheels;
                    }
                }
                if (!frameHasBuiltInWheels(document.getElementById('altFrame').value)) {
                    if (savedAltWheels && document.getElementById('altWheels').querySelector(`option[value="${savedAltWheels}"]`)) {
                        document.getElementById('altWheels').value = savedAltWheels;
                    }
                }
                
                // Sync wheel dropdown states (disabled for built-in wheel frames)
                syncWheelDropdownState('actual');
                syncWheelDropdownState('alt');
                
                // Restore upgrade levels from cache
                const savedActualLevel = localStorage.getItem('zwift_actualLevel');
                const savedAltLevel = localStorage.getItem('zwift_altLevel');
                if (savedActualLevel !== null) document.getElementById('actualLevel').value = savedActualLevel;
                if (savedAltLevel !== null) document.getElementById('altLevel').value = savedAltLevel;
                
                updateBikeStats('actual');
                updateBikeStats('alt');
            } catch (e) {
                console.error('Failed to load wheels:', e);
            }
        }
        
        function calculateFrontalAreaFor(prefix) {
            // Faria frontal area formula (drops position)
            // Matches the formula used by ZwifterBikes when deriving Cd values
            const height = parseFloat(document.getElementById(prefix + 'RiderHeight').value) || 175;
            const weight = parseFloat(document.getElementById(prefix + 'RiderWeight').value) || 75;
            
            // FA = 0.0293 √ó H^0.725 √ó M^0.425 + 0.0604 (H in metres)
            const heightM = height / 100;
            const frontalArea = 0.0293 * Math.pow(heightM, 0.725) * Math.pow(weight, 0.425) + 0.0604;
            
            document.getElementById(prefix + 'FrontalAreaValue').textContent = frontalArea.toFixed(3);
            return frontalArea;
        }
        
        function calculateFrontalArea() {
            calculateFrontalAreaFor('actual');
            calculateFrontalAreaFor('alt');
        }
        
        function syncRiderSettings() {
            // Copy actual rider settings to alternative
            document.getElementById('altRiderHeight').value = document.getElementById('actualRiderHeight').value;
            document.getElementById('altRiderWeight').value = document.getElementById('actualRiderWeight').value;
            calculateFrontalArea();
        }
        
        async function loadMyProfile() {
            try {
                const resp = await fetch('/api/my_profile');
                if (!resp.ok) return;
                const data = await resp.json();
                if (data.height_cm && data.weight_kg) {
                    myProfile = data;
                }
            } catch (e) {
                console.log('Could not load profile:', e);
            }
        }
        
        async function applyMyStats(prefix) {
            if (!myProfile) {
                await loadMyProfile();
            }
            if (!myProfile) {
                alert('Not logged in or profile not available. Please log in first.');
                return;
            }
            document.getElementById(prefix + 'RiderHeight').value = myProfile.height_cm;
            document.getElementById(prefix + 'RiderWeight').value = myProfile.weight_kg;
            calculateFrontalAreaFor(prefix);
        }
        
        function copyBike(from, to) {
            document.getElementById(to + 'Frame').value = document.getElementById(from + 'Frame').value;
            document.getElementById(to + 'Wheels').value = document.getElementById(from + 'Wheels').value;
            document.getElementById(to + 'Level').value = document.getElementById(from + 'Level').value;
            syncWheelDropdownState(to);
            updateBikeStats(to);
        }
        
        function copyRider(from, to) {
            document.getElementById(to + 'RiderHeight').value = document.getElementById(from + 'RiderHeight').value;
            document.getElementById(to + 'RiderWeight').value = document.getElementById(from + 'RiderWeight').value;
            calculateFrontalAreaFor(to);
        }
        
        // Debounced auto-compare for rider input changes
        let riderDebounceTimer = null;
        function debouncedCompare() {
            clearTimeout(riderDebounceTimer);
            riderDebounceTimer = setTimeout(() => { if (telemetryData) runComparison(); }, 500);
        }
        
        // Update frontal area and auto-compare when height/weight changes
        document.getElementById('actualRiderHeight').addEventListener('input', () => { calculateFrontalAreaFor('actual'); debouncedCompare(); });
        document.getElementById('actualRiderWeight').addEventListener('input', () => { calculateFrontalAreaFor('actual'); debouncedCompare(); });
        document.getElementById('altRiderHeight').addEventListener('input', () => { calculateFrontalAreaFor('alt'); debouncedCompare(); });
        document.getElementById('altRiderWeight').addEventListener('input', () => { calculateFrontalAreaFor('alt'); debouncedCompare(); });
        
        // Calculate initial values
        setTimeout(calculateFrontalArea, 100);
        
        // Time range slider logic
        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }
        
        function initTimeRangeSlider(cooldownStartSec) {
            if (!fullTelemetryData || !fullTelemetryData.time_sec || fullTelemetryData.time_sec.length === 0) return;
            
            const times = fullTelemetryData.time_sec;
            const maxSec = Math.ceil(times[times.length - 1]);
            const defaultEnd = (cooldownStartSec != null && cooldownStartSec < maxSec) ? Math.ceil(cooldownStartSec) : maxSec;
            
            const startSlider = document.getElementById('rangeStart');
            const endSlider = document.getElementById('rangeEnd');
            
            startSlider.min = 0;
            startSlider.max = maxSec;
            startSlider.value = 0;
            endSlider.min = 0;
            endSlider.max = maxSec;
            endSlider.value = defaultEnd;
            
            document.getElementById('timeRangeContainer').classList.add('visible');
            updateRangeDisplay();
            
            // Apply the default range filter (excludes cooldown)
            if (defaultEnd < maxSec) {
                applyTimeRange();
            }
        }
        
        function updateRangeDisplay() {
            const startSlider = document.getElementById('rangeStart');
            const endSlider = document.getElementById('rangeEnd');
            let startVal = parseInt(startSlider.value);
            let endVal = parseInt(endSlider.value);
            
            document.getElementById('rangeStartLabel').textContent = formatTime(startVal);
            document.getElementById('rangeEndLabel').textContent = formatTime(endVal);
            
            const duration = Math.max(0, endVal - startVal);
            document.getElementById('rangeDuration').textContent = `(${formatTime(duration)})`;
            
            // Update track fill
            const max = parseInt(endSlider.max);
            const pctStart = (startVal / max) * 100;
            const pctEnd = (endVal / max) * 100;
            const fill = document.getElementById('rangeTrackFill');
            fill.style.left = pctStart + '%';
            fill.style.width = (pctEnd - pctStart) + '%';
            
            // Show filtered point count
            if (fullTelemetryData) {
                const times = fullTelemetryData.time_sec;
                const count = times.filter(t => t >= startVal && t <= endVal).length;
                document.getElementById('rangePointsInfo').textContent = `${count} of ${times.length} data points selected`;
            }
        }
        
        function applyTimeRange() {
            if (!fullTelemetryData) return;
            
            const startVal = parseInt(document.getElementById('rangeStart').value);
            const endVal = parseInt(document.getElementById('rangeEnd').value);
            const times = fullTelemetryData.time_sec;
            
            // Find indices within range
            const indices = [];
            for (let i = 0; i < times.length; i++) {
                if (times[i] >= startVal && times[i] <= endVal) indices.push(i);
            }
            
            if (indices.length < 30) {
                telemetryData = fullTelemetryData; // Fallback
                return;
            }
            
            // Build filtered telemetry
            telemetryData = {};
            for (const key of Object.keys(fullTelemetryData)) {
                telemetryData[key] = indices.map(i => fullTelemetryData[key][i]);
            }
        }
        
        let rangeDebounceTimer = null;
        function onRangeInput() {
            // Prevent start from exceeding end and vice versa
            const startSlider = document.getElementById('rangeStart');
            const endSlider = document.getElementById('rangeEnd');
            if (parseInt(startSlider.value) >= parseInt(endSlider.value) - 10) {
                if (this === startSlider) {
                    startSlider.value = parseInt(endSlider.value) - 10;
                } else {
                    endSlider.value = parseInt(startSlider.value) + 10;
                }
            }
            updateRangeDisplay();
            
            clearTimeout(rangeDebounceTimer);
            rangeDebounceTimer = setTimeout(() => {
                applyTimeRange();
                if (telemetryData) runComparison();
                // Auto-refresh best bikes if they were already shown
                if (telemetryData && !document.getElementById('bestBikesContainer').classList.contains('hidden')) {
                    findBestBikes();
                }
            }, 400);
        }
        
        document.getElementById('rangeStart').addEventListener('input', onRangeInput);
        document.getElementById('rangeEnd').addEventListener('input', onRangeInput);
        
        async function updateBikeStats(prefix) {
            const frameSelect = document.getElementById(`${prefix}Frame`);
            const wheelSelect = document.getElementById(`${prefix}Wheels`);
            const levelSelect = document.getElementById(`${prefix}Level`);
            
            const frameId = frameSelect.value;
            const level = levelSelect.value;
            
            // For built-in wheel frames, force wheel to empty and disable dropdown
            syncWheelDropdownState(prefix);
            const wheelId = wheelSelect.value;
            
            // Save selections to browser cache
            const key = prefix === 'actual' ? 'actual' : 'alt';
            localStorage.setItem(`zwift_${key}Frame`, frameId);
            localStorage.setItem(`zwift_${key}Wheels`, wheelId);
            localStorage.setItem(`zwift_${key}Level`, level);
            
            if (!frameId) return;
            
            try {
                const resp = await fetch(`/api/bike_stats?frame_id=${frameId}&wheel_id=${wheelId}&upgrade_level=${level}`);
                
                if (resp.ok) {
                    const stats = await resp.json();
                    document.getElementById(`${prefix}Cd`).textContent = stats.cd.toFixed(4);
                    document.getElementById(`${prefix}Weight`).textContent = `${stats.weight_kg.toFixed(2)} kg`;
                } else {
                    document.getElementById(`${prefix}Cd`).textContent = 'N/A';
                    document.getElementById(`${prefix}Weight`).textContent = 'N/A';
                }
            } catch (e) {
                console.error('Failed to get bike stats:', e);
            }
            
            // Auto-refresh comparison
            if (telemetryData) runComparison();
            
            // Auto-refresh best bikes if they were already shown and actual bike changed
            if (prefix === 'actual' && telemetryData && !document.getElementById('bestBikesContainer').classList.contains('hidden')) {
                findBestBikes();
            }
        }
        
        function updateActivityLink() {
            const activityId = document.getElementById('activityId').value.trim();
            const link = document.getElementById('activityLink');
            if (activityId) {
                link.href = `https://www.zwift.com/activity/${activityId}`;
                link.style.display = 'inline-block';
            } else {
                link.style.display = 'none';
            }
        }
        
        document.getElementById('activityId').addEventListener('input', updateActivityLink);
        
        function handleFitSelect(input) {
            const nameEl = document.getElementById('fitFileName');
            const btn = document.getElementById('fitUploadBtn');
            if (input.files.length > 0) {
                nameEl.textContent = input.files[0].name;
                nameEl.style.color = '#e0e0e0';
                btn.disabled = false;
            } else {
                nameEl.textContent = 'No file selected';
                nameEl.style.color = '#aaa';
                btn.disabled = true;
            }
        }
        
        async function uploadFitFile() {
            const fileInput = document.getElementById('fitFileInput');
            const infoEl = document.getElementById('activityInfo');
            const btn = document.getElementById('fitUploadBtn');
            
            if (!fileInput.files.length) {
                infoEl.textContent = 'Please select a .fit file';
                infoEl.className = 'activity-info error';
                return;
            }
            
            const file = fileInput.files[0];
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Parsing...';
            infoEl.textContent = '';
            
            // Hide stale comparison results
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('bestBikesContainer').classList.add('hidden');
            document.getElementById('bestBikesBody').innerHTML = '';
            document.getElementById('bestBikesFootnote').style.display = 'none';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const resp = await fetch('/api/upload_fit', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await resp.json();
                
                if (resp.ok && data.success) {
                    fullTelemetryData = data.telemetry;
                    telemetryData = data.telemetry;
                    initTimeRangeSlider(data.cooldown_start_sec);
                    
                    // Clear activity ID field since we're using file data
                    document.getElementById('activityId').value = '';
                    document.getElementById('activityLink').style.display = 'none';
                    localStorage.removeItem('zwift_activityId');
                    const url = new URL(window.location);
                    url.searchParams.delete('activity');
                    window.history.replaceState({}, '', url);
                    
                    let msg = `‚úì Loaded ${data.points} points from ${data.filename}, ${data.distance_km} km, ${Math.round(data.duration_sec/60)} min`;
                    infoEl.textContent = msg;
                    infoEl.className = 'activity-info success';
                    document.getElementById('findBestBtn').disabled = false;
                    
                    // Auto-run comparison with current bike selections
                    if (document.getElementById('actualFrame').value && document.getElementById('altFrame').value) {
                        runComparison();
                    }
                } else {
                    infoEl.textContent = `‚úó ${data.error || 'Failed to parse FIT file'}`;
                    infoEl.className = 'activity-info error';
                    telemetryData = null;
                    fullTelemetryData = null;
                    document.getElementById('findBestBtn').disabled = true;
                    document.getElementById('timeRangeContainer').classList.remove('visible');
                }
            } catch (e) {
                infoEl.textContent = `‚úó Error: ${e.message}`;
                infoEl.className = 'activity-info error';
                telemetryData = null;
                fullTelemetryData = null;
                document.getElementById('findBestBtn').disabled = true;
                document.getElementById('timeRangeContainer').classList.remove('visible');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Upload';
            }
        }
        
        async function fetchActivity() {
            const activityId = document.getElementById('activityId').value.trim();
            const infoEl = document.getElementById('activityInfo');
            const btn = document.getElementById('fetchBtn');
            
            if (!activityId) {
                infoEl.textContent = 'Please enter an activity ID';
                infoEl.className = 'activity-info error';
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Fetching...';
            infoEl.textContent = '';
            
            // Hide stale comparison results from previous activity
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('bestBikesContainer').classList.add('hidden');
            document.getElementById('bestBikesBody').innerHTML = '';
            document.getElementById('bestBikesFootnote').style.display = 'none';
            
            try {
                const resp = await fetch('/api/fetch_activity', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({activity_id: activityId})
                });
                
                const data = await resp.json();
                
                if (resp.ok && data.success) {
                    fullTelemetryData = data.telemetry;
                    telemetryData = data.telemetry;
                    initTimeRangeSlider(data.cooldown_start_sec);
                    localStorage.setItem('zwift_activityId', activityId);
                    const url = new URL(window.location);
                    url.searchParams.set('activity', activityId);
                    window.history.replaceState({}, '', url);
                    let msg = `‚úì Loaded ${data.points} points, ${data.distance_km} km, ${Math.round(data.duration_sec/60)} min`;
                    
                    // Auto-populate rider height/weight from profile
                    if (data.rider_profile) {
                        const rp = data.rider_profile;
                        if (rp.height_cm && rp.height_cm > 0) {
                            document.getElementById('actualRiderHeight').value = rp.height_cm;
                            document.getElementById('altRiderHeight').value = rp.height_cm;
                        }
                        if (rp.weight_kg && rp.weight_kg > 0) {
                            document.getElementById('actualRiderWeight').value = rp.weight_kg;
                            document.getElementById('altRiderWeight').value = rp.weight_kg;
                        }
                        calculateFrontalArea();
                        if (rp.name) {
                            msg += ` | Rider: ${rp.name} (${rp.height_cm}cm, ${rp.weight_kg}kg)`;
                        }
                    }
                    
                    infoEl.textContent = msg;
                    infoEl.className = 'activity-info success';
                    document.getElementById('findBestBtn').disabled = false;
                    
                    // Auto-run comparison with current bike selections
                    if (document.getElementById('actualFrame').value && document.getElementById('altFrame').value) {
                        runComparison();
                    }
                } else {
                    console.error('Activity fetch error:', resp.status, data);
                    infoEl.textContent = `‚úó ${data.error || 'Failed to fetch'}`;
                    infoEl.className = 'activity-info error';
                    telemetryData = null;
                    fullTelemetryData = null;
                    document.getElementById('findBestBtn').disabled = true;
                    document.getElementById('timeRangeContainer').classList.remove('visible');
                }
            } catch (e) {
                infoEl.textContent = `‚úó Error: ${e.message}`;
                infoEl.className = 'activity-info error';
                telemetryData = null;
                fullTelemetryData = null;
                document.getElementById('findBestBtn').disabled = true;
                document.getElementById('timeRangeContainer').classList.remove('visible');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Fetch Activity';
            }
        }
        
        async function runComparison() {
            const resultsSection = document.getElementById('resultsSection');
            
            if (!telemetryData) {
                resultsSection.classList.add('hidden');
                return;
            }
            
            const payload = {
                actual: {
                    frame_id: document.getElementById('actualFrame').value,
                    wheel_id: document.getElementById('actualWheels').value,
                    upgrade_level: parseInt(document.getElementById('actualLevel').value)
                },
                alternative: {
                    frame_id: document.getElementById('altFrame').value,
                    wheel_id: document.getElementById('altWheels').value,
                    upgrade_level: parseInt(document.getElementById('altLevel').value)
                },
                rider_weight: parseFloat(document.getElementById('actualRiderWeight').value),
                rider_height: parseFloat(document.getElementById('actualRiderHeight').value),
                alt_rider_weight: parseFloat(document.getElementById('altRiderWeight').value),
                alt_rider_height: parseFloat(document.getElementById('altRiderHeight').value),
                telemetry: telemetryData
            };
            
            try {
                const resp = await fetch('/api/compare', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const data = await resp.json();
                
                if (resp.ok) {
                    displayResults(data);
                    resultsSection.classList.remove('hidden');
                } else {
                    alert(`Comparison failed: ${data.error}`);
                }
            } catch (e) {
                alert(`Error: ${e.message}`);
            }
        }
        
        function displayResults(data) {
            // Update summary cards with Normalized Power
            document.getElementById('actualNp').textContent = data.summary.actual_np;
            document.getElementById('altNp').textContent = data.summary.alternative_np;
            
            const npDiff = data.summary.np_diff;
            document.getElementById('npDiff').textContent = `${npDiff > 0 ? '+' : ''}${npDiff} W`;
            
            const diffCard = document.getElementById('diffCard');
            diffCard.classList.remove('positive', 'negative', 'neutral');
            diffCard.classList.add(npDiff > 0 ? 'positive' : npDiff < 0 ? 'negative' : 'neutral');
            
            const avgDiff = data.summary.avg_watts_diff;
            document.getElementById('avgWattsDiff').textContent = `${avgDiff > 0 ? '+' : ''}${avgDiff} W`;
            
            const avgDiffCard = document.getElementById('avgDiffCard');
            avgDiffCard.classList.remove('positive', 'negative', 'neutral');
            avgDiffCard.classList.add(avgDiff > 0 ? 'positive' : avgDiff < 0 ? 'negative' : 'neutral');
            
            // Create power chart
            createPowerChart(data);
            createDiffChart(data);
        }
        
        function createPowerChart(data) {
            const ctx = document.getElementById('powerChart').getContext('2d');
            
            if (powerChart) powerChart.destroy();
            
            powerChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.chart_data.time_min.map(t => t.toFixed(1)),
                    datasets: [
                        {
                            label: 'Actual Bike',
                            data: data.chart_data.actual_watts,
                            borderColor: '#4fc3f7',
                            backgroundColor: 'rgba(79, 195, 247, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'Alternative Bike',
                            data: data.chart_data.alternative_watts,
                            borderColor: '#ff6b35',
                            backgroundColor: 'rgba(255, 107, 53, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'Est. Draft Savings',
                            data: data.chart_data.draft_watts,
                            borderColor: '#66bb6a',
                            backgroundColor: 'rgba(102, 187, 106, 0.15)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            borderDash: [5, 3]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Time (min)', color: '#888' },
                            ticks: { color: '#888', maxTicksLimit: 15 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            title: { display: true, text: 'Power (W)', color: '#888' },
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }
        
        function createDiffChart(data) {
            const ctx = document.getElementById('diffChart').getContext('2d');
            
            if (diffChart) diffChart.destroy();
            
            // Color segments based on positive/negative
            const colors = data.chart_data.watts_difference.map(d => 
                d > 0 ? 'rgba(244, 67, 54, 0.7)' : 'rgba(76, 175, 80, 0.7)'
            );
            
            diffChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.chart_data.time_min.map(t => t.toFixed(1)),
                    datasets: [
                        {
                            label: 'Watts Difference',
                            data: data.chart_data.watts_difference,
                            backgroundColor: colors,
                            borderWidth: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Time (min)', color: '#888' },
                            ticks: { color: '#888', maxTicksLimit: 15 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            title: { display: true, text: 'Watts Difference', color: '#888' },
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }
        
        async function findBestBikes() {
            const statusEl = document.getElementById('bestBikesStatus');
            const container = document.getElementById('bestBikesContainer');
            const bestBody = document.getElementById('bestBikesBody');
            
            if (!telemetryData) {
                statusEl.textContent = '‚ö† Please load telemetry data first';
                statusEl.style.color = '#f44336';
                return;
            }
            
            statusEl.textContent = '‚è≥ Counting bike combinations...';
            statusEl.style.color = '#f7931e';
            
            const maxRiderLevelVal = document.getElementById('maxRiderLevel').value;
            const searchParams = {
                telemetry: telemetryData,
                rider_weight: parseFloat(document.getElementById('actualRiderWeight').value),
                rider_height: parseFloat(document.getElementById('actualRiderHeight').value),
                upgrade_level: parseInt(document.getElementById('bestBikesLevel').value),
                exclude_tt: document.getElementById('excludeTT').checked,
                exclude_special: document.getElementById('excludeSpecial').checked,
                use_pareto: document.getElementById('usePareto').checked,
                max_rider_level: maxRiderLevelVal ? parseInt(maxRiderLevelVal) : null,
                excluded_frames: [...excludedFrames],
                actual_bike: {
                    frame_id: document.getElementById('actualFrame').value,
                    wheel_id: document.getElementById('actualWheels').value,
                    upgrade_level: parseInt(document.getElementById('actualLevel').value)
                },
                top_n: 10
            };
            
            // Get exact combo count from server (fast - no simulation)
            try {
                const countResp = await fetch('/api/combo_count', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(searchParams)
                });
                const countData = await countResp.json();
                statusEl.textContent = `‚è≥ Searching ${countData.count.toLocaleString()} bike combinations...`;
            } catch (e) {
                statusEl.textContent = '‚è≥ Searching bike combinations...';
            }
            
            try {
                const resp = await fetch('/api/best_bikes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(searchParams)
                });
                
                const data = await resp.json();
                
                if (resp.ok && data.success) {
                    statusEl.textContent = `‚úì Analyzed ${data.total_combos} bike combinations`;
                    statusEl.style.color = '#4caf50';
                    
                    // Show actual NP
                    document.getElementById('actualNpValue').textContent = `${data.actual_np} W`;
                    
                    // Populate best bikes
                    let bestHtml = '';
                    data.best_bikes.forEach((bike, i) => {
                        const diff = bike.np - data.actual_np;
                        const diffStr = diff >= 0 ? `+${diff.toFixed(1)}` : diff.toFixed(1);
                        const diffColor = diff <= 0 ? '#4caf50' : '#f44336';
                        const isActual = bike.is_actual;
                        const rowStyle = isActual ? 'background: rgba(247, 147, 30, 0.2); border: 2px solid #f7931e;' : '';
                        const actualTag = isActual ? ' <span style="color: #f7931e; font-size: 0.8em;">(YOUR BIKE)</span>' : '';
                        
                        bestHtml += `<tr style="${rowStyle}">
                            <td style="color: #4caf50; font-weight: bold;">${i + 1}</td>
                            <td style="text-align: left;">${bike.name}${actualTag}</td>
                            <td>${bike.cd.toFixed(4)}</td>
                            <td>${bike.weight_kg.toFixed(2)} kg</td>
                            <td style="color: #ffd54f;">${bike.drops_cost != null ? bike.drops_cost.toLocaleString() : '‚Äî'}${bike.non_shop ? '*' : ''}</td>
                            <td style="font-weight: bold;">${bike.np} W</td>
                            <td style="color: ${diffColor}; font-weight: bold;">${diffStr} W</td>
                            <td>
                                <button class="btn-use-bike" onclick="selectBike('alt', '${bike.frame_id}', '${bike.wheel_id}')">Use</button>
                                ${!isActual ? `<button class="btn-use-bike" onclick="excludeFrame('${bike.frame_id}', '${bike.frame_name}')" style="background: rgba(244,67,54,0.2); color: #f44336; border-color: #f44336; margin-left: 4px;" title="Exclude this frame and re-search">‚úï</button>` : ''}
                            </td>
                        </tr>`;
                    });
                    bestBody.innerHTML = bestHtml;
                    
                    // Show footnote if any result has non-shop items
                    const hasNonShop = data.best_bikes.some(b => b.non_shop);
                    document.getElementById('bestBikesFootnote').style.display = hasNonShop ? 'block' : 'none';
                    
                    container.classList.remove('hidden');
                } else {
                    statusEl.textContent = `‚úó ${data.error || 'Failed to find best bikes'}`;
                    statusEl.style.color = '#f44336';
                }
            } catch (e) {
                statusEl.textContent = `‚úó Error: ${e.message}`;
                statusEl.style.color = '#f44336';
            }
        }
        
        function excludeFrame(frameId, frameName) {
            excludedFrames.add(frameId);
            updateExcludedBar();
            findBestBikes();
        }
        
        function removeExcludedFrame(frameId) {
            excludedFrames.delete(frameId);
            updateExcludedBar();
            findBestBikes();
        }
        
        function clearExcludedFrames() {
            excludedFrames.clear();
            updateExcludedBar();
            findBestBikes();
        }
        
        function updateExcludedBar() {
            const bar = document.getElementById('excludedFramesBar');
            const list = document.getElementById('excludedFramesList');
            if (excludedFrames.size === 0) {
                bar.style.display = 'none';
                return;
            }
            bar.style.display = 'block';
            let html = '';
            excludedFrames.forEach(fid => {
                const frame = frames.find(f => f.id === fid);
                const name = frame ? frame.name : fid;
                html += `<span style="display: inline-block; background: rgba(244,67,54,0.2); border: 1px solid rgba(244,67,54,0.4); border-radius: 12px; padding: 2px 10px; margin: 2px 4px; font-size: 0.8rem; color: #ff8a80;">${name} <span onclick="removeExcludedFrame('${fid}')" style="cursor: pointer; margin-left: 4px; color: #f44336;" title="Remove exclusion">&times;</span></span>`;
            });
            list.innerHTML = html;
        }
        
        function selectBike(panel, frameId, wheelId) {
            // Set the frame and wheel dropdowns to the selected bike
            const frameSelect = document.getElementById(panel + 'Frame');
            const wheelSelect = document.getElementById(panel + 'Wheels');
            
            if (frameId) frameSelect.value = frameId;
            // Set wheel - syncWheelDropdownState handles built-in wheel frames
            if (wheelId) {
                wheelSelect.value = wheelId;
            }
            syncWheelDropdownState(panel);
            
            // Sync upgrade level from best bikes search if selecting alternative
            if (panel === 'alt') {
                const bestBikesLevel = document.getElementById('bestBikesLevel').value;
                document.getElementById('altLevel').value = bestBikesLevel;
            }
            
            // Update stats display (also saves to cache)
            updateBikeStats(panel);
            
            // Scroll to bike panels
            document.querySelector('.bike-panels').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
